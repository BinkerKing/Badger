<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>我的代码块</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
	<div class="scrollbar">
		<div class="content">
			<div class="main-panel-pos main-panel-two">
				<div class="main-panel-left" lay-filter="side">
					<div class="layui-side-scroll">
						<div id="sidebar" class="rk-panel-header">
							<h3>代码块</h3>
							<span class="right-btn-bg-n" onclick="addCode()"  id="add-data">
								<i class="iconfont icon-tianjia" title="添加"></i>
							</span>
						</div>
				 	  	<div class="rk-panel-list-search-wrapper">
			 	  	  		<input placeholder="搜索" class="layui-input rk-input-search" type="text">
				 	  	  	<span class="rk-panel-list-search-action"><i class="iconfont icon-sousuo"></i></span>
			 	  	  	</div>
						<div class="rk-panel-content rk-panel-list-search">
							 <ul class="layui-nav layui-nav-tree layui-form" id="codeList"></ul>
						</div>
					</div>
				</div>
				<div class="main-panel-left" lay-filter="side" style="margin-left:255px;">
					<div class="layui-side-scroll">
						<div id="sidebar" class="rk-panel-header">
							<h3>代码</h3>
							<span class="right-btn-bg-n" onclick="addFile()"  id="add-data">
								<i class="iconfont icon-tianjia" title="添加"></i>
							</span>
						</div>
						<div class="rk-panel-content rk-panel-list-search">
							 <ul class="layui-nav layui-nav-tree" id="fileList"></ul>
						</div>
					</div>
				</div>
				<div class="main-panel-right" style="margin-left:510px">
					<div class="layui-side-scroll">
						<div id="sidebar" class="rk-panel-header">
							<h3>fileName</h3>
						</div>
						<div class="rk-panel-content">
							<textarea id="code" name="code"></textarea>
						 </div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<link type="include" href="/common/tools/codeMirror.html" />
<script>
	/*全局定义*/
	var form = layui.form, layer = layui.layer;
	var custId = 1;
	
	$(function(){
		//同步渲染模板
		var funs = [loadCodes];
		View.deferred(funs,function(obj){
			funs = [loadFiles];
			View.deferred(funs,function(obj){
				loadContent();
			});
		});
	});
	

	//codeList全局变量
	var CodeList;//所有code列表--包含fileList
	var CurCode;//当前code
	var CurContent;//当前内容
	
	//加载codeList
	function loadCodes(obj,callbackFun){
		//获取用户所有代码块信息
		var url =  Const.apiUrl + "/TCdeInfoController/getCodeList"
		View.get(url, "custId="+custId, function(ds) {
			if(ds && ds.length > 0){
				CurCode = ds[0];
			}
			CodeList = ds;
			drawCodes(callbackFun);
		}, function() {
			TmplUtils.showMsgFail("出错");
		})
	}
	
	//绘制codeList模板
	function drawCodes(callbackFun){
		drawTmpl({
			"container" : $("#codeList"),
			"tmpl" : $("#codeListTmpl").html(),
		},function(callback){
			callback.call(this,CodeList);//数据
			callbackFun.call();
		},function(){
			$("#codeList li").eq(0).addClass("layui-this");
		});
	}
	
	//加载fileList
	function loadFiles(obj,callbackFun){
		drawFiles(callbackFun);
	}
	
	//绘制fileList模板
	function drawFiles(callbackFun){
		var fileList = JSON.parse(CurCode.fileListJson);
		drawTmpl({
			"container" : $("#fileList"),
			"tmpl" : $("#fileListTmpl").html(),
		},function(callback){
			callback.call(this,fileList);//数据
			callbackFun.call();
		},function(){
			$("#fileList li").eq(0).addClass("layui-this");
		});
	}
	
	//加载内容
	function loadContent(obj,callbackFun){
		var fileList = JSON.parse(CurCode.fileListJson);
		var contentId = fileList[0].id;
		//获取当前内容
		var url =  Const.apiUrl + "/TCdeInfoController/getContent"
		View.get(url, "contentId="+contentId, function(ds) {
			CurContent = ds;
			editor.setValue(CurContent.content);
		}, function() {
			TmplUtils.showMsgFail("出错");
		})
	}
	
	//模板绘制方法
	function drawTmpl(opt,bindFun,finishFun){
		var tmpl = new View.Tmpl(opt);
		tmpl.onFinish(finishFun);
		tmpl.onload(function(){
			tmpl.bind(bindFun);
		});
	}
	
	function save(){
		
	}
	
	function editFile(){
		
	}
	
	function removeFile(){
		
	}
	
</script>
<script id="codeListTmpl" type="text/tmpl">
{{#
	layui.each(d, function(index, item){
}}
<li class="layui-nav-item"><a href="javascript:">{{=item.title}}</a></li>
{{# }); }}
</script>
<script id="fileListTmpl" type="text/tmpl">
{{#
	layui.each(d, function(index, item){
}}
<li class="layui-nav-item " title="{{=item.fileName}}">
<a href="javascript:editFile({{=item.id}})">{{=item.fileName}}</a><i class="iconfont icon-delete" onclick="removeFile({{=item.id}})" title="删除"></i></li>
{{# }); }}
</script>
</html>